package db

import (
	"errors"
	"github.com/mediocregopher/radix.v2/pool"
	"github.com/msawangwan/unet/util"
)

const (
	CONN_TYPE = "tcp"
	CONN_SIZE = 10
	LADDR     = "localhost:6379"

	K_NAMES_NOT_AVAIL   = "profile_name:taken"
	KEY_WORLD_IS_LOADED = "profile_world:by_name:"
	KEY_WORLD_NODES     = "profile_world:valid_stars"

	VAL_INIT = "_init_"

	CMD_EXIST = "EXISTS"
	// strings
	CMD_S = "SET"
	CMD_G = "GET"
	// sets
	CMD_SADDMEM = "SADD"
	CMD_SISMEM  = "SISMEMBER"
	CMD_SETMEM  = "SMEMBERS"
)

type RedisHandle struct {
	DB *pool.Pool
}

var Redis *RedisHandle

func init() {
	var db *pool.Pool
	var err error

	db, err = pool.New(CONN_TYPE, LADDR, CONN_SIZE)

	if err != nil {
		util.Log.InitPanic(err)
	}

	Redis = &RedisHandle{
		DB: db,
	}

	err = Redis.createNameDB()

	if err != nil {
		util.Log.InitMessage(err.Error())
	}

	util.Log.InitMessage("redis ready ...")
}

var (
	ErrOnInitDB        = errors.New("redis: error on setup")
	ErrAlreadyExistsDB = errors.New("redis: db already exists")
)

// createNameDB is a setup function that runs only once ever
func (rh *RedisHandle) createNameDB() error {
	conn, err := rh.DB.Get()
	if err != nil {
		return err
	}
	defer rh.DB.Put(conn)

	query := conn.Cmd(CMD_EXIST, K_NAMES_NOT_AVAIL)
	if query.Err != nil {
		return query.Err
	} else {
		result, _ := query.Int()
		if result == 1 {
			return ErrAlreadyExistsDB
		}
	}

	if conn.Cmd(CMD_SADDMEM, K_NAMES_NOT_AVAIL, VAL_INIT).Err != nil {
		return ErrOnInitDB
	} else {
		return nil
	}
}

func (rh *RedisHandle) CreateKey_IsWorldInMemory(key string) string {
	return fmt.Sprintf("%s%s", kKEY_IS_LOADED_IN_MEMORY, key)
}

func (rh *RedisHandle) CreateKey_ValidWorldNodes(key string) string {
	return fmt.Sprintf("%s%s", kKEY_WORLD_NODES, key)
}
